name: Verify Pages index install

on:
  workflow_run:
    workflows: ["Pages"]
    types: [completed]

permissions:
  contents: read

concurrency:
  group: verify-index-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: true

jobs:
  verify:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-15]
        python: ["3.14", "3.14t"]
    steps:
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python }}

      - uses: astral-sh/setup-uv@v7

      - name: Wait for Pages to be reachable
        shell: bash
        run: |
          set -euo pipefail
          BASE="https://mikz.github.io/jsrun"
          INDEX_NIGHTLY="${BASE}/nightly/simple/"
          INDEX_STABLE="${BASE}/simple/"

          for i in $(seq 1 60); do
            if curl -fsSL "${INDEX_NIGHTLY}" | grep -q 'href="jsrun/' ; then
              echo "Pages reachable and PEP 503 root present."
              exit 0
            fi
            echo "Pages index not reachable yet ($i/60), waiting 10s..."
            sleep 10
          done
          echo "ERROR: GitHub Pages PEP 503 index not reachable at ${INDEX_NIGHTLY}. Ensure Pages is enabled and set to 'GitHub Actions' source."
          exit 1

      - name: Create venv
        shell: bash
        run: |
          set -euo pipefail
          uv venv --seed -p python .venv

      - name: Install from nightly index
        shell: bash
        run: |
          set -euo pipefail
          INDEX="https://mikz.github.io/jsrun/nightly/simple/"
          for i in $(seq 1 60); do
            if curl -fsSL "${INDEX}jsrun/" | grep -Eiq '\.(whl|tar\.gz)</a>' ; then
              echo "Nightly package index populated."
              break
            fi
            echo "Nightly package index not populated yet ($i/60), waiting 10s..."
            sleep 10
          done
          curl -fsSL "${INDEX}jsrun/" | head -n 100
          uv pip install \
            --python .venv/bin/python \
            --default-index "$INDEX" \
            --index-strategy first-index \
            --no-deps \
            jsrun

      - name: Import smoke (nightly)
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ matrix.python }}" == *t ]]; then
            PYTHON_GIL=0 .venv/bin/python -W error::RuntimeWarning -c 'import jsrun, sys; assert hasattr(sys, "_is_gil_enabled"); assert not sys._is_gil_enabled()'
          else
            .venv/bin/python -c 'import jsrun'
          fi

      - name: Install from stable index (if available)
        shell: bash
        run: |
          set -euo pipefail
          INDEX="https://mikz.github.io/jsrun/simple/"
          if curl -fsSL "${INDEX}jsrun/" | grep -Eiq '\.(whl|tar\.gz)</a>' ; then
            uv pip install \
              --python .venv/bin/python \
              --default-index "$INDEX" \
              --index-strategy first-index \
              --no-deps \
              --reinstall-package jsrun \
              jsrun
          else
            echo "No stable wheels found in ${INDEX}jsrun/; skipping stable install check."
          fi

      - name: Import smoke (stable)
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ matrix.python }}" == *t ]]; then
            PYTHON_GIL=0 .venv/bin/python -W error::RuntimeWarning -c 'import jsrun, sys; assert hasattr(sys, "_is_gil_enabled"); assert not sys._is_gil_enabled()'
          else
            .venv/bin/python -c 'import jsrun'
          fi
