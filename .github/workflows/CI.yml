name: CI

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write  # Required for creating releases
  id-token: write  # Required for Workload Identity Federation and PyPI trusted publishing

jobs:

  macos:
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      matrix:
        platform:
          - runner: macos-15
            target: aarch64
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v6
      - uses: astral-sh/setup-uv@v7
      - uses: dtolnay/rust-toolchain@stable
      - name: Test
        run: make all
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.platform.target }}
          path: dist

  test-macos-314t:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v6
        with:
          python-version: '3.14t'
      - uses: astral-sh/setup-uv@v7
      - uses: dtolnay/rust-toolchain@stable
      - name: Install deps + build extension
        run: |
          uv sync --frozen --group testing
          uv run maturin develop --uv
      - name: Free-threaded import check (GIL stays off)
        run: |
          PYTHON_GIL=0 uv run python -W error::RuntimeWarning -m pytest tests/test_freethreading_import.py -v
      - name: Run test suite (GIL disabled)
        run: |
          PYTHON_GIL=0 uv run python -m pytest tests/ -q

  sdist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: dist

  # Provision GCP Spot VM with self-hosted runner
  provision:
    runs-on: ubuntu-latest
    outputs:
      runner-name: ${{ steps.create-vm.outputs.runner_name }}
    steps:
      - uses: actions/checkout@v5

      - id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v3

      - name: Get GitHub Runner Token
        id: get-token
        run: |
          echo "Requesting runner registration token for ${{ github.repository }}"
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.GH_PAT }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/runners/registration-token)

          TOKEN=$(echo "$RESPONSE" | jq -r .token)

          if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
            echo "Failed to get registration token"
            echo "Error message: $(echo "$RESPONSE" | jq -r .message)"
            exit 1
          fi

          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          echo "Successfully obtained registration token"

      - name: Create Spot VM
        id: create-vm
        run: |
          RUNNER_NAME="gcp-runner-${{ github.run_id }}-${{ github.run_attempt }}"
          echo "runner_name=$RUNNER_NAME" >> $GITHUB_OUTPUT

          gcloud compute instances create $RUNNER_NAME \
            --zone=${{ vars.GCP_ZONE || 'us-central1-a' }} \
            --machine-type=${{ vars.GCP_MACHINE_TYPE || 'n2-highcpu-32' }} \
            --provisioning-model=SPOT \
            --instance-termination-action=DELETE \
            --image-family=ubuntu-2204-lts \
            --image-project=ubuntu-os-cloud \
            --boot-disk-size=200GB \
            --metadata=runner-token=${{ steps.get-token.outputs.token }},repo-url=https://github.com/${{ github.repository }},runner-name=$RUNNER_NAME \
            --metadata-from-file=startup-script=.github/scripts/startup.sh

      - name: Wait for Runner Registration
        run: |
          echo "Waiting for runner to register..."
          for i in {1..60}; do
            if curl -s -H "Authorization: token ${{ secrets.GH_PAT }}" \
              https://api.github.com/repos/${{ github.repository }}/actions/runners \
              | jq -e '.runners[] | select(.name == "${{ steps.create-vm.outputs.runner_name }}")' > /dev/null; then
              echo "Runner registered successfully!"
              exit 0
            fi
            echo "Attempt $i/60: Runner not yet registered, waiting 10s..."
            sleep 10
          done
          echo "Runner failed to register within 10 minutes"
          exit 1

  # Build manylinux wheels (x86_64 and aarch64) on self-hosted GCP runner
  build-wheels-manylinux:
    needs: provision
    runs-on: [self-hosted, gcp, spot]
    steps:
      - uses: actions/checkout@v5

      - name: Verify runner environment
        run: |
          echo "Building manylinux wheels"
          echo "Runner name: ${{ runner.name }}"
          echo "Runner OS: ${{ runner.os }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          uname -a
          df -h
          free -h
          docker --version

      # Build x86_64
      - name: Build x86_64 Docker image
        run: |
          docker build \
            -t jsrun-manylinux-builder:x86_64 \
            -f .github/docker/Dockerfile.x86_64 \
            .github/docker/

      - name: Build x86_64 wheels in Docker
        run: |
          mkdir -p dist
          docker run --rm \
            -v "$(pwd):/workdir" \
            -w /workdir \
            jsrun-manylinux-builder:x86_64 \
            bash .github/scripts/build-manylinux-wheels.sh x86_64-unknown-linux-gnu

      # Build aarch64
      - name: Build aarch64 Docker image
        run: |
          docker build \
            -t jsrun-manylinux-builder:aarch64 \
            -f .github/docker/Dockerfile.aarch64 \
            .github/docker/

      - name: Build aarch64 wheels in Docker
        run: |
          mkdir -p dist
          docker run --rm \
            -v "$(pwd):/workdir" \
            -w /workdir \
            jsrun-manylinux-builder:aarch64 \
            bash .github/scripts/build-manylinux-wheels.sh aarch64-unknown-linux-gnu

      # Upload all wheels
      - name: List all built wheels
        run: |
          echo "All built wheels:"
          ls -lh dist/

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-manylinux
          path: dist/*.whl

  # Test built manylinux wheels on GitHub ubuntu runners
  test-wheels-x86_64:
    needs: build-wheels-manylinux
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13', '3.14', '3.14t']
      fail-fast: false
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
      - name: Download manylinux wheels
        uses: actions/download-artifact@v6
        with:
          name: wheels-linux-manylinux
          path: dist
      - name: Install wheel and dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install --no-index --find-links dist jsrun || { echo "Available wheels:"; ls -lh dist/; exit 1; }
          python -m pip install pytest pytest-asyncio

      - name: Free-threaded import check (GIL stays off)
        if: endsWith(matrix.python-version, 't')
        run: |
          PYTHON_GIL=0 python -W error::RuntimeWarning -m pytest tests/test_freethreading_import.py -v

      - name: Run test suite
        run: |
          pytest tests/ -v

  test-wheels-aarch64:
    needs: build-wheels-manylinux
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13', '3.14']
      fail-fast: false
    steps:
      - uses: actions/checkout@v5
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      - name: Download manylinux wheels
        uses: actions/download-artifact@v6
        with:
          name: wheels-linux-manylinux
          path: dist
      - name: Test wheel in aarch64 container
        run: |
          docker run --rm --platform linux/arm64 \
            -v "$(pwd):/work" \
            -w /work \
            python:${{ matrix.python-version }}-slim \
            bash -c "
              pip install --upgrade pip && \
              pip install --no-index --find-links /work/dist jsrun && \
              pip install pytest pytest-asyncio && \
              pytest tests/ -v
            "

  test-wheels-aarch64-314t:
    needs: build-wheels-manylinux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      - name: Download manylinux wheels
        uses: actions/download-artifact@v6
        with:
          name: wheels-linux-manylinux
          path: dist
      - name: Test 3.14t wheel in manylinux aarch64 container
        run: |
          docker run --rm --platform linux/arm64 \
            -v "$(pwd):/work" \
            -w /work \
            quay.io/pypa/manylinux_2_28_aarch64 \
            bash -lc '
              set -euo pipefail
              PY=/opt/python/cp314-cp314t/bin/python
              if [[ ! -x "$PY" ]]; then
                echo "Missing free-threaded Python at $PY"
                echo "Available interpreters:"
                ls -1 /opt/python || true
                exit 1
              fi

              "$PY" -m ensurepip --upgrade --default-pip || true
              "$PY" -m pip install --upgrade pip
              "$PY" -m pip install pytest pytest-asyncio
              "$PY" -m pip install --no-index --find-links /work/dist jsrun

              PYTHON_GIL=0 "$PY" -W error::RuntimeWarning -m pytest /work/tests/test_freethreading_import.py -v
              PYTHON_GIL=0 "$PY" -m pytest /work/tests/test_freethreading_concurrency_smoke.py -q
              PYTHON_GIL=0 "$PY" -m pytest /work/tests/test_jsrun_api.py -q -k threadpool_context_propagation_does_not_share_runtime
            '

  # Cleanup: Delete the GCP VM
  cleanup:
    needs: [provision, build-wheels-manylinux]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v3

      - name: Delete VM
        run: |
          gcloud compute instances delete ${{ needs.provision.outputs.runner-name }} \
            --zone=${{ vars.GCP_ZONE || 'us-central1-a' }} \
            --quiet || echo "VM may have already been terminated"

  # Create GitHub Release with all artifacts
  release:
    needs: [macos, test-macos-314t, sdist, build-wheels-manylinux, test-wheels-x86_64, test-wheels-aarch64, test-wheels-aarch64-314t]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v5

      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -name '*.whl' -exec cp {} release-assets/ \;
          find artifacts -name '*.tar.gz' -exec cp {} release-assets/ \;
          ls -lh release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
          generate_release_notes: true
          fail_on_unmatched_files: true

  # Publish to PyPI using trusted publishing
  publish:
    needs: [release]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    environment:
      name: pypi
      url: https://pypi.org/p/jsrun
    permissions:
      id-token: write  # Required for PyPI trusted publishing
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts

      - name: Prepare distribution files
        run: |
          mkdir -p dist
          find artifacts -name '*.whl' -exec cp {} dist/ \;
          find artifacts -name '*.tar.gz' -exec cp {} dist/ \;
          ls -lh dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
