# aarch64 manylinux builder for jsrun wheels.
#
# This image runs on native linux/arm64 runners and links against the provided
# glibc 2.28 sysroot for manylinux compatibility.

FROM ghcr.io/rust-cross/manylinux_2_28-cross:aarch64

ENV DEBIAN_FRONTEND=noninteractive

RUN echo "deb https://apt.llvm.org/jammy/ llvm-toolchain-jammy-19 main" > /etc/apt/sources.list.d/llvm-toolchain-jammy-19.list && \
    curl -fsSL https://apt.llvm.org/llvm-snapshot.gpg.key | gpg --dearmor > /etc/apt/trusted.gpg.d/llvm-snapshot.gpg && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        clang-19 \
        lld-19 \
        libclang-19-dev \
        libc++-19-dev \
        libc++abi-19-dev \
        ninja-build \
        python3.11 \
        git && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:${PATH}"

RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal
ENV PATH="/root/.cargo/bin:${PATH}"

ENV CC=clang-19
ENV CXX=clang-19
ENV LIBCLANG_PATH=/usr/lib/llvm-19/lib
ENV PATH=/usr/lib/llvm-19/bin:${PATH}

ENV PYTHON=/usr/bin/python3.11

# Keep the aarch64 sysroot provided by the cross toolchain so V8 links against
# glibc 2.28 rather than the host.
ENV TARGET_SYSROOT=/usr/aarch64-unknown-linux-gnu/aarch64-unknown-linux-gnu/sysroot
ENV QEMU_LD_PREFIX=/usr/aarch64-unknown-linux-gnu/aarch64-unknown-linux-gnu/sysroot
ENV PKG_CONFIG_SYSROOT_DIR=/usr/aarch64-unknown-linux-gnu/aarch64-unknown-linux-gnu/sysroot
ENV PKG_CONFIG_PATH=/usr/aarch64-unknown-linux-gnu/aarch64-unknown-linux-gnu/sysroot/usr/lib/pkgconfig:/usr/aarch64-unknown-linux-gnu/aarch64-unknown-linux-gnu/sysroot/usr/share/pkgconfig

ENV BINDGEN_EXTRA_CLANG_ARGS_aarch64_unknown_linux_gnu="--sysroot=/usr/aarch64-unknown-linux-gnu/aarch64-unknown-linux-gnu/sysroot -Ithird_party/libc++/src/include -Ithird_party/libc++abi/src/include -Ibuildtools/third_party/libc++ -isystem/usr/aarch64-unknown-linux-gnu/aarch64-unknown-linux-gnu/sysroot/usr/include -isystem/usr/aarch64-unknown-linux-gnu/aarch64-unknown-linux-gnu/sysroot/usr/include/aarch64-linux-gnu"
ENV CC_aarch64_unknown_linux_gnu=aarch64-unknown-linux-gnu-gcc
ENV CXX_aarch64_unknown_linux_gnu=aarch64-unknown-linux-gnu-g++
ENV AR_aarch64_unknown_linux_gnu=aarch64-unknown-linux-gnu-ar
ENV CARGO_BUILD_TARGET=aarch64-unknown-linux-gnu
ENV CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-unknown-linux-gnu-gcc

ENV EXTRA_GN_ARGS="target_sysroot=\"/usr/aarch64-unknown-linux-gnu/aarch64-unknown-linux-gnu/sysroot\" treat_warnings_as_errors=false use_glib=false"

# Use upstream prebuilt rusty_v8 archive for aarch64 instead of building V8
# from source. Native arm64 runner builds avoid QEMU instability.
ENV V8_FROM_SOURCE=0

RUN printf '%s\n' \
    '#!/bin/bash' \
    '' \
    'set -euo pipefail' \
    '' \
    '/opt/python/cp312-cp312/bin/python "/opt/_internal/build_scripts/manylinux-interpreters.py" "$@"' \
    > /usr/local/bin/manylinux-interpreters && chmod +x /usr/local/bin/manylinux-interpreters

WORKDIR /workdir

CMD ["/bin/bash"]
